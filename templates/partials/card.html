<div class="container">
  <div class="card mb-4">
    <div class="row g-0">
        <!-- Imagen -->
        <div class="col-md-4">
          <img src="{{ paciente.imagen }}"
                class="img-fluid rounded-start img-cover img-detalle-fixed" alt="Foto paciente">
          <div>
            <input class="edit-mode form-control mt-3" type="file" name="imagen" accept="image/*" style="display:none;">
          </div>
        </div>

      <!-- Detalles -->
      <div class="col-md-8">
        <div class="card-body">
          <h2 class="card-title">
            <span class="view-mode">{{ paciente.nombre }}</span>
            <input class="edit-mode form-control" type="text" name="nombre" value="{{ paciente.nombre }}" style="display:none;">
          </h2>

          <div class="row">
            <div class="col-sm-6">
              <p class="card-text"><strong>Especie:</strong> 
                <span class="view-mode">{{ paciente.especie }}</span>
                <select class="edit-mode form-select" name="especie" style="display:none;">
                  <option value="Canino" {% if paciente.especie == 'Canino' %}selected{% endif %}>Canino</option>
                  <option value="Felino" {% if paciente.especie == 'Felino' %}selected{% endif %}>Felino</option>
                  <option value="Roedor" {% if paciente.especie == 'Roedor' %}selected{% endif %}>Roedor</option>
                  <option value="Reptil" {% if paciente.especie == 'Reptil' %}selected{% endif %}>Reptil</option>
                  <option value="Ave" {% if paciente.especie == 'Ave' %}selected{% endif %}>Ave</option>
                  <option value="Otros" {% if paciente.especie == 'Otros' %}selected{% endif %}>Otros</option>
                </select>
              </p>
              <p class="card-text"><strong>Raza:</strong> 
                <span class="view-mode">{{ paciente.raza }}</span>
                <input class="edit-mode form-control" type="text" name="raza" value="{{ paciente.raza }}" style="display:none;">
              </p>
              <p class="card-text"><strong>Sexo:</strong> 
              <span class="view-mode">{{ paciente.sexo }}</span>
  
                <select class="edit-mode form-select" name="sexo" style="display:none;">
                  <option value="Macho" {% if paciente.sexo == 'Macho' %}selected{% endif %}>Macho</option>
                  <option value="Hembra" {% if paciente.sexo == 'Hembra' %}selected{% endif %}>Hembra</option>
                </select>
              </p>
              <p class="card-text"><strong>Color:</strong> 
                <span class="view-mode">{{ paciente.color }}</span>
                <input class="edit-mode form-control" type="text" name="color" value="{{ paciente.color }}" style="display:none;">
              </p>
            </div>

            <div class="col-sm-6">
              <p class="card-text"><strong>Fecha de nacimiento:</strong> 
                <span class="view-mode">{{ paciente.fecha_nacimiento }}</span>
                <input class="edit-mode form-control" type="date" name="fecha_nacimiento" 
                       value="{{ paciente.fecha_nacimiento.strftime('%Y-%m-%d') if paciente.fecha_nacimiento else '' }}" 
                       style="display:none;">
              </p>

              <p class="card-text"><strong>Castrado:</strong> 
                <span class="view-mode">{{ 'Sí' if paciente.castrado else 'No' }}</span>
                <input class="edit-mode form-check-input" type="checkbox" name="castrado" 
                       {% if paciente.castrado %}checked{% endif %} style="display:none;">
              </p>

              <p class="card-text"><strong>Reproductor:</strong> 
                <span class="view-mode">{{ 'Sí' if paciente.reproductor else 'No' }}</span>
                <input class="edit-mode form-check-input" type="checkbox" name="reproductor" 
                       {% if paciente.reproductor %}checked{% endif %} style="display:none;">
              </p>

              <p class="card-text"><strong>Activo:</strong> 
                <span class="view-mode">{{ 'Sí' if paciente.activo else 'No' }}</span>
                <input class="edit-mode form-check-input" type="checkbox" name="activo" 
                       {% if paciente.activo %}checked{% endif %} style="display:none;">
              </p>
            </div>
          </div>

              <button id="editBtn" class="btn btn-primary">Editar</button>
              <button id="saveBtn" class="btn btn-success" style="display:none;">Guardar</button>
                  <div class="col-auto">
                      {% if paciente and paciente.id %}
                          <a id="cancelBtn" href="/paciente/{{ paciente.id }}" class="btn btn-secondary mt-2">Cancelar</a>
                      {% else %}
                          <a id="cancelBtn" href="{{ url_for('home_bp.buscar') }}" class="btn btn-secondary mt-2">Cancelar</a>
                      {% endif %}
                  </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

<script>
const cancelBtn = document.getElementById("cancelBtn");
const homeUrl = "{{ url_for('home_bp.buscar') }}";

// --- LÓGICA DE COMPORTAMIENTO INICIAL ---
// Si estamos en la página de un paciente existente: 
// En modo VISTA, Cancelar debe ir al Home.
{% if paciente and paciente.id %}
    if (cancelBtn) {
        // Al cargar la página (Modo Vista), el botón Cancelar apunta al Home.
        cancelBtn.href = homeUrl;
    }
{% endif %}
// ----------------------------------------

document.getElementById("editBtn").addEventListener("click", function() {
    // Mostrar/ocultar inputs
    document.querySelectorAll(".view-mode").forEach(e => e.style.display = "none");
    document.querySelectorAll(".edit-mode").forEach(e => e.style.display = "inline-block");
    document.getElementById("editBtn").style.display = "none";
    document.getElementById("saveBtn").style.display = "inline-block";

    document.getElementById("cancelBtn").textContent = "Volver";
    // ----------------------------------------------------
    // Lógica para el botón Cancelar en Modo EDICIÓN
    // ----------------------------------------------------
    if (cancelBtn) {
        // 1. Guardar el enlace original (Home) en un atributo de datos
        const originalHref = cancelBtn.getAttribute('href'); 
        cancelBtn.setAttribute('data-original-href', originalHref); 
        // 2. Cambiar el href para que Cancelar recargue la página actual (descarta cambios)
        cancelBtn.href = window.location.href; 
    }
});

document.getElementById("saveBtn").addEventListener("click", async function() {
    // --- INICIO DE LA VALIDACIÓN ---
    
    const camposObligatorios = [
        'nombre', 'especie', 'raza', 'color', 'fecha_nacimiento'
    ];
    let esValido = true;

    // Primero, limpiamos errores de validaciones anteriores
    document.querySelectorAll(".edit-mode.is-invalid").forEach(el => {
        el.classList.remove('is-invalid');
    });

    // Validamos cada campo obligatorio
    camposObligatorios.forEach(nombreCampo => {
        const input = document.querySelector(`.edit-mode[name="${nombreCampo}"]`);
        // Usamos trim() para eliminar espacios en blanco al inicio y al final
        if (!input.value || input.value.trim() === '') {
            input.classList.add('is-invalid'); // Añade el borde rojo
            esValido = false;
        }
    });

    if (!esValido) {
       
        const errorModal = new bootstrap.Modal(document.getElementById('validationErrorModal'));

    
        document.getElementById('modalErrorMessage').textContent = "Falta/n completar algunos de los campos.";


        errorModal.show();
    
    return; // Detiene la ejecución si hay errores
      }

    // --- FIN DE LA VALIDACIÓN ---

    // Si la validación pasa, continuamos con el envío de datos
    const data = new FormData();

    document.querySelectorAll(".edit-mode").forEach(input => {
        if (input.type === "checkbox") {
            if (input.checked) {
                data.append(input.name, "on");
            }
        } else if (input.type === "file") {
            if (input.files.length > 0) {
                data.append(input.name, input.files[0]);
            }
        } else {
            data.append(input.name, input.value);
        }
    });

    const resp = await fetch("/paciente/actualizar/{{ paciente.id }}", {
        method: "PUT",
        body: data
    });

    if (resp.ok) {
        // Si es exitoso, recargar la página para ver los cambios y volver al modo vista.
        location.reload();
    } else {
        alert("Error al guardar los cambios");
    }
});
</script>